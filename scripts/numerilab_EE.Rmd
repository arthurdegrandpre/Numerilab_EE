---
title: "Numérilab - Introduction à Google Earth Engine"
author: "Esteban Hamel et Arthur de Grandpré"
date: "14 janvier 2021"
output: 
  html_document: 
    highlight: haddock
    keep_md: yes
    theme: readable
    toc: yes
---

```{r setup}
library(knitr)
library(png)
```


# Résumé
Cet atelier Numérliab a pour objectif d'introduire la plateforme Google Earth Engine (EE) et certaines de ses fonctionnalités.  

Earth Engine est un logiciel en ligne de la compagnie Google qui met à la disposition de ses utilisateurs une grande variété de couches géographiques (images satellitaires, données climatiques, topographiques, etc.), ainsi que des outils pour les analyser. L’avantage de EE est qu’une grande majorité des calculs sont faits directement par les serveurs de Google sur le cloud, donc beaucoup plus rapidement que sur un ordinateur personnel. Le but de cet atelier n’est pas d'apprendre un nouveau language de programmation, mais plutôt de présenter certains outils et codes reproductibles et adaptables à vos besoins.

# Objectifs
- Importer et visualiser des images satellites propres à une région et un moment donné  
- Travailler avec des images satellites pour une région déterminée par un fichier shapefile  
- Faire un calcul du NDVI  
- Faire une classification d’image satellite  
- Exporter les couches produites sous forme de raster  

# Étape 1 : Introduction à l'interface EE

### NOTE : AJOUT DE LIENS / MÉTHODES D'ACCÈS A EE? p-e un peu plus d'intro de base

Voici quelques informations pour vous retrouver dans l'interface

```{r, echo=F}
img_path = dir("../data/imgs/",full.names=T)
include_graphics(img_path[1])
```
### NOTE: P-E grandir la figure un peu?

**Panneau de gauche**  
-	Bibliothèque où sont enregistrés tous vos codes  
-	Bibliothèque de GEE où sont les exemples de codes et la description des outils GEE  
-	Bibliothèque de vos propres couches (shapefiles, raster et autres bases de données).  

**Panneau du centre**  
- Éditeur de code où vous faites vos calculs  

**Panneau de droite**  
- Onglet d’inspection de la couche pour inspecter les métadonnées de votre carte (informations sur les couches et les pixels)  
- Console des sorties où l’information des différentes cartes ou les graphiques s’affichent  
- Gestionnaire de tâche pour les documents importés ou exportés  

**Barre de recherche**  
- Pour rechercher un lieu ou des couches de données  

**Carte**  
- Carte interactive où sont affichées vos couches calculées par-dessus une carte typique de Google  

# Étape 2 : Sélectionner un lieu d’intérêt à l’aide des outils de géométrie

Naviguer sur la carte jusqu’au Parc National de la Mauricie. Il est aussi possible de faire une recherche à l’aide de la barre de recherche, p. ex. "Shawinigan".  

1.	À l’aide de l’outil de géométrie, « ajouter un repère » en cliquant sur le pictogramme de repère et déposez-le au milieu du Parc national.  
2.	Cliquer sur « exit » une fois que le repère est placé  
3.	Renommer le nouveau repère « pnm » dans le haut de votre script  
  
*Alternative*, utiliser la ligne de code suivante  

```{javascript, eval=F}
var pnm = /* color: #d63000 */ee.Geometry.Point([-72.97, 46.74])
```

**N’oubliez pas d’enregistrer votre code à l’aide du bouton enregistrer**

```{r, echo=F}
include_graphics(img_path[2])
```

# Étape 3 : Charger et afficher une carte de l’élévation

Pour importer une couche, vous devrez la charger à partir de la banque de données de Earth Engine. Pour cela, il suffit de rechercher au sein du catalogue EE à l’aide de la barre de recherche et de l’importer. À noter que lorsqu’une couche est importée elle ne s’affichera pas directement. Comme aucunes limites n’ont été spécifiées pour cette couche, elle contient l’information reliée à une énorme superficie et le mieux est de la filtrer pour avoir un affichage autour d’un lieu d’intérêt.  Voici un exemple avec des données d’élévation.  
  
-	Pour ajouter la couche d’élévation SRTM, rechercher et sélectionner la couche NASA SRTM Digital Elevation 30m  

-	Vous pouvez consulter l’information disponible pour cette couche dans les différents onglets du panneau qui s’est affiché. Ensuite, cliquez sur importer pour que la couche s’ajoute à votre environnement EE.  

```{r, echo=F}
include_graphics(img_path[3])
```

-	Une fois ajoutée, vous pouvez renommer la couche « srtm » 

```{r, echo=F}
include_graphics(img_path[4])
```

- Pour afficher les propriétés de la couche importée utiliser le code suivant et le résultat s’affichera dans le panneau droit

```{javascript, eval=F}
print(srtm);
```

- Pour afficher la couche srtm, il suffit d'utiliser la commande « Map.addLayer » qui permet d’ajouter une couche à la carte. Cependant il faut souvent définir des paramètres de visualisation pour améliorer les paramètres par défaut des couches. 

```{javascript, eval=F}
Map.addLayer(srtm);
```

```{r, echo=F}
include_graphics(img_path[5])
```

-	Pour afficher plus en détail le relief, il suffit de mettre des valeurs de relief plus près de celle de notre lieu d’intérêt. Il est aussi possible d’ajouter un nom à la couche que vous faites afficher.

```{javascript, eval=F}
Map.addLayer(srtm, {min: 0, max: 400},"Élévation");
```

-	Pour faciliter la visualisation de l'élévation, il est possible de donner un gradient de couleur aux valeurs d’élévation.

```{javascript, eval=F}
Map.addLayer(srtm, {min: 0, max: 400, palette: ['blue', 'yellow', 'red']},"Élévation colorée");
```

```{r, echo=F}
include_graphics(img_path[6])
```

- L’information sur l’élévation est utile, mais elle peut être complémentée avec d’autres informations comme le relief au sol et les pentes. Les outils ee.Terrain.hillshade() et ee.Terrain.slope() permettent de calculer rapidement ces attributs.

```{javascript, eval=F}
var ombre = ee.Terrain.hillshade(srtm);
Map.addLayer(ombre, {min: 150, max:255}, 'Ombre');

var pente = ee.Terrain.slope(srtm);
Map.addLayer(pente, {min: 0, max: 30}, 'Pente')
```

```{r, echo=F}
include_graphics(img_path[7])
```


# Étape 4 : Travailler avec des images satellitaires pour une région déterminée

Le catalogue de données de Google Earth Engine permet d'accéder à de nombreuses sources d'images satellitaires. Pour travailler sur d’un lieu d’intérêt, il faudra filtrer les données disponibles pour ce lieu pour une période donnée. Commencez par importer les images du satellite Sentinel 2 (aussi possible pour Landsat).  

- Pour ce faire, rechercher « sentinel » dans la barre de recherche et sélectionner «Sentinel-2 MSI : Multispectral Instrument, Level-1C, l'importer puis renommer l’objet « sent2 »

```{r, echo=F}
include_graphics(img_path[8])
```

- Utiliser le code ci-dessous pour voir le nombre d’images trouvées autour du lieu d’intérêt qu’est le Parc national de la Mauricie entre septembre et octobre 2020, avec moins de 10% de couverture nuageuse.

```{javascript, eval=F}
var pnm_s2=sent2.filterBounds(pnm)
                              .filterDate("2020-07-01", "2020-08-30")
                              .filterMetadata('CLOUDY_PIXEL_PERCENTAGE','less_than',10);

print(pnm_s2.size(),"n. images");
print(pnm_s2, "propriétés pnm_s2")
                              
```

-	Une autre façon serait de trier la bibliothèque d’image selon les critères désirés autour d’un point

```{javascript, eval=F}
var pnm_s2_best = ee.ImageCollection(sent2)
    .filterDate("2020-07-01", "2020-09-30")
    .filterBounds(pnm)
    .sort("CLOUD_COVERAGE_ASSESSMENT")
    .first();

print(pnm_s2_best,"meilleur image");
    
//extra : 2nd best?
var pnm_s2_2best = ee.ImageCollection(sent2)
    .filterDate("2020-07-01", "2020-09-30")
    .filterBounds(pnm)
    .sort("CLOUD_COVERAGE_ASSESSMENT")
    .tolist(2).get(1); 
print(pnm_s2_2best, "2e meilleur image")
      
```

-	Pour afficher l’image satellite, utilisez la fonction « Map.addLayer », cependant il faudra définir d’avance certains paramètres de visualisation. Ces paramètres viseront à afficher les bandes rouge, bleu et verte.

```{r javascript, eval=F}

var couleur_rgb = {
        bands: ["B4", "B3", "B2"],
        min: 0,
        max: 1850
        };

Map.addLayer(pnm_s2_best,couleur_rgb,"Image Sentinel-2");
```

# Étape 5 : Sélectionner des images satellitaires selon les contours d’un shapefile

Dans les étapes précédentes, le lieu d’intérêt était le Parc National de la Maurice. Un repère a été placé à un endroit aléatoire dans le Parc. Il est cependant possible de travailler dans Earth Engine avec des superficies prédéterminées par exemple dans le cas d’un fichier shapefile. Pour ce faire, il vous faudra importer les fichiers shapefiles de votre ordinateur vers Google Earth Engine.  
  
- Aller dans l’onglet « assets » pour voir les couches externes -> New -> Shape files  

```{r, echo=F}
include_graphics(img_path[9])
```

-	Sélectionner les couches .shp; .dbf;.shx;.prj associé à la couche shapefile désirée à partir d’un répertoire sur  votre ordinateur. -> Taper le nom que vous voulez lui donner ex. « PNM_poly » -> Upload

```{r, echo=F}
include_graphics(img_path[10])
```

- Pour confirmer que le fichier est importé, consulter le gestionnaire de tâche dans l’onglet « Task » du panneau droit. Une fois le fichier téléchargé, la barre de téléchargement devrait être remplie et si vous actualisez votre répertoire de couche, la couche importée devrait être affichée dans le panneau de gauche. 

```{r, echo=F}
include_graphics(img_path[11])
```

- Pour importer la couche shapefile dans votre code, cliquer sur la couche dans le panneau de gauche -> Importer -> renommer la couche « shape_pnm » dans votre code

```{r, echo=F}
include_graphics(img_path[12])
```

- Le code suivant aurait aussi permis de faire cette même opération

```{javascript, eval=F}
var pnm_poly = ee.FeatureCollection('users/XXX/PNM_poly');
```

Une fois le fichier shapefile importé, il est possible d’afficher la photo satellite seulement pour cette superficie avec l’outil «.clip » et le code suivant:

### probablement besoin de démêler les différents calls. aussi, pourquoi la fonction median et pourquoi définir polygone

```{javascript, eval=F}
var polygone = pnm_s2_best.median();
Map.addLayer(polygone.clip(shape_pnm),couleur_rgb,"Image Satellite ajustée1");
```

ou encore

```{javascript, eval=F}
Map.addLayer(image.clip(shape_pnm),couleur_rgb,"Image Satellite ajustée2");
```

Alternative Arthur : 

```{javascript, eval=F}
var pnm_clip = pnm_s2_best.clip(shape_pnm);
Map.addLayer(pnm_clip,couleur_rgb,"Image Satellite coupée");
```

```{r, echo=F}
include_graphics(img_path[13])
```

# Étape 6 : Calculer un indice spectrale (ex: NDVI)

Un autre exercice qui requiert peu de code avec Google Earth Engine est de créer une nouvelle couche de donnée qui contient une bande calculée comme l’indice NDVI (Normalized difference vegetation index).  
  
Ce type d'index est souvent utilisé pour mettre en évidence certains éléments des images. Dans le cas du NDVI, il s'agit d'un ratio entre les réflectances des bandes rouge et proche infra-rouge qui permet de mettre en évidence la présence de végétation au sein d'une image.  

$$NDVI = \frac{NIR-RED}{NIR+RED} $$
Différentes méthodes permettent de créer une telle couche :

### NOTE : ici j'Ai mis une version alternative de tes chunks avec des calls qui fonctionnaient mieux pour moi, je ne suis pas certain de pourquoi tu callais region.map et de l'utilité de maxNDVI, on en jasera
1. utiliser une fonction  
  
```{javascript, eval=F}
var ndvi = region.map (function (image) {
  var result=image.normalizedDifference(["B8", "B4"]).rename("NDVI"); 
  return image.addBands(result);
});
var maxNDVI= ndvi.select("NDVI");
Map.addLayer(maxNDVI, {min:0,max:1,palette:['red','yellow','green']},"NDVI Méthode1");
```
  
version Arthur : 

```{javascript, eval=F}
var ndvi = function (pnm_clip) {
  var result=pnm_clip.normalizedDifference(["B8", "B4"]).rename("NDVI"); 
  return pnm_clip.addBands(result);
};

Map.addLayer(ndvi(pnm_clip), {bands:['NDVI'],min:0,max:1,palette:['red','yellow','green']},"NDVI Méthode1");
```
  
  
2. faire un calcul de la différence des bandes dans une expression  

```{javascript, eval=F}
var NDVI2 = image.expression(
     "(NIR - RED) / (NIR + RED)",
    {
      RED: image.select("B4"),    //  RED
      NIR: image.select("B8"),    // NIR
 });
Map.addLayer(NDVI2, {min: 0, max: 1,palette:['cyan','green','orange'] }, "NDVI Méthode 2");
```

version Arthur:

```{javascript, eval=F}
var ndvi2 = pnm_clip.expression(
     "(NIR - RED) / (NIR + RED)",
    {
      RED: image.select("B4"),
      NIR: image.select("B8"),
 });
Map.addLayer(ndvi2, {min: 0, max: 1,palette:['cyan','green','orange'] }, "NDVI Méthode 2");
```

# Étape 7 : Faire une classification d'image à l'aide de Google Earth Engine

Le prochain exercice vise à introduire à la classification d’image à l’aide de Google Earth Engine. Le code ci-dessous permettra de faire une classification supervisée des différents types de paysages à partir d’image satellite.  À l’aide d’un jeu de données préliminaires où les différents types de paysages sont connus, l’outil X permet d’extrapoler la classification à une plus grande échelle.  
  
### NOTE: outil à identifier, ça pourrait être considéré comme du machine learning de bas niveau

- La première manipulation sera de créer les polygones du jeu de données d’entrainement. Faites attention à ne  pas prendre de trop grosses superficies, sinon il pourrait y avoir une erreur lorsque vous exécuterez le code. À l’aide des outils de géométrie, créer un polygone dans un endroit boisé. Refaites cette manipulation pour des polygones que vous placerez dans une terre agricole, une étendue d’eau et en milieu urbain. Ces polygones  s’appelleront  respectivement « foret », « agricole », « eau » et « ville »

```{r, echo=F}
include_graphics(img_path[14])
```

- Ensuite, il faut ajouter une étiquette à chacun des polygones, un peu de la même manière qu’on ajoute des attributs à la table d’attribut d’un polygone dans un shapefile. Ces étiquettes seront utiles lorsqu’on assemblera les polygones dans une même couche. Pour ajouter une étiquette, aller dans les propriétés d’un polygone -> sélectionner « FeatureCollection » -> Ajouter une propriété -> la nommer « landcover » et lui donner une valeur de 0 -> Ok.  Refaite de même avec les autres polygones où vous créerez une propriété nommée « landcover » et avec des valeurs de 1,2 et 3 respectivement. Après cela, chaque polygone devrait être rendu un objet « FeatureCollection ».

```{r, echo=F}
include_graphics(img_path[15])
```

-	Il faut maintenant combiner les polygones ensemble dans une même couche. Utiliser le code suivant pour faire cet assemblage et voyer le résultat dans le panneau de droite.

```{javascript, eval=F}
var classNames = foret.merge(agricole).merge(eau).merge(ville);
print(classNames);
```

```{r, echo=F}
include_graphics(img_path[16])
```

-	Vous êtes maintenant en mesure d’utiliser la couche précédente pour créer un jeu de données d’entrainement pour la classification à plus grande échelle. Le jeu de donnée d’entrainement va calculer quelles sont les valeurs des pixels reliés à chaque polygone pour les différentes bandes spectrales, ici les bandes 2 à 7. 

### NOTE: pourquoi 2 à 7? vite comme ça 2,3,4,8 serait probablement un meilleur choix

```{javascript, echo=F}
var bands = ['B2', 'B3', 'B4', 'B8']; // pour définir les bandes a utiliser

// le jeu de donnée
var training = image.select(bands).sampleRegions({
  collection: classNames,
  properties: ['landcover'],
  scale: 30
});

print(training, 'data training');
```

-	Vous pouvez maintenant faire le test de votre classification sur l’image satellite complète.

```{javascript, echo=F}
//L’algorithme de classification (ici l'outil .cart mais il y en a d'autres)
var classifier = ee.Classifier.cart().train({
  features: training,
  classProperty: 'landcover',
  inputProperties: bands
});

var classification = image.select(bands).classify(classifier);
```

```{r, echo=F}
include_graphics(img_path[17])
```

### NOTE: ça pourrait être fait directement sur l'image crop du pnm+ndvi+srtm non? donc on évite d'avoir à regénérer le stack, je crois que si on tourne en rond on va prendre trop de temps

# Étape 8 : Exportation vers un fichier raster via Google Drive

Il est possible d’exporter les couches créées dans Google Earth Engine pour continuer de les modifier dans des logiciels SIG. Par exemple, on pourrait vouloir exporter une partie de la classification précédente dans un fichier raster. Comme l’image satellite est relativement volumineuse, vous exporterez seulement une partie de la couche. 

-	Pour définir la région d’exportation, ajouter un repère que vous nommerez « exporter ».

### SUGGESTION: peut-être montrer qu'il est facile de faire le tout en batch pour genre toutes les images d'une année ou d'une série? je crois que c'est là la grosse force de EE